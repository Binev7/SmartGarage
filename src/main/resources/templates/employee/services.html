<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin | Services</title>
    <div th:replace="~{fragments/common :: header-css}"></div>
</head>
<body class="bg-dark text-white">
<div th:replace="~{fragments/common :: navbar-admin}"></div>

<main class="container py-5 mt-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-4">
            <h2 class="fw-bold m-0 text-uppercase">Garage <span class="text-orange">Services</span></h2>
        </div>

        <div class="col-md-2">
            <form th:action="@{/employee/services}" method="get">
                <input type="hidden" name="search" th:value="${searchQuery}">
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-black text-secondary border-orange"><i class="bi bi-currency-exchange"></i></span>
                    <select name="currency" class="form-select bg-black text-orange border-orange fw-bold rounded-0" onchange="this.form.submit()">
                        <option th:each="curr : ${currencies}"
                                th:value="${curr}"
                                th:text="${curr}"
                                th:selected="${curr == selectedCurrency}"></option>
                    </select>
                </div>
            </form>
        </div>

        <div class="col-md-6 text-end">
            <form th:action="@{/employee/services}" method="get" class="d-inline-flex gap-2">
                <input type="hidden" name="currency" th:value="${selectedCurrency}">
                <input type="text" name="search" th:value="${searchQuery}"
                       class="form-control bg-black text-white border-secondary rounded-0"
                       placeholder="Search by name...">
                <button type="submit" class="btn btn-outline-orange rounded-0"><i class="bi bi-search"></i></button>
                <a th:href="@{/employee/services}" class="btn btn-outline-secondary rounded-0"><i class="bi bi-x-circle"></i></a>
            </form>
            <button class="btn btn-orange rounded-0 fw-bold ms-3" data-bs-toggle="modal" data-bs-target="#serviceModal" onclick="clearModal()">
                <i class="bi bi-plus-lg"></i> NEW
            </button>
        </div>
    </div>

    <div th:if="${message}" class="alert alert-success bg-dark text-success border-success rounded-0 fade show" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger bg-dark text-danger border-danger rounded-0 fade show" th:text="${error}"></div>

    <div class="table-responsive shadow-lg">
        <table class="table table-dark table-hover mb-0 border-secondary">
            <thead class="bg-black text-orange text-uppercase">
            <tr>
                <th class="py-3 px-4">Service Name</th>
                <th class="py-3">Price (<span th:text="${selectedCurrency}"></span>)</th>
                <th class="py-3 text-end px-4">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s : ${services}" class="align-middle border-secondary">
                <td class="px-4 fw-bold text-white" th:text="${s.name}"></td>

                <td class="text-orange fw-bold">
                    <span th:text="${#numbers.formatDecimal(s.price.multiply(rate), 1, 2)}"></span>
                    <span th:text="${selectedCurrency}"></span>
                </td>

                <td class="text-end px-4">
                    <button class="btn btn-sm btn-outline-light rounded-0 me-2"
                            type="button"
                            th:data-id="${s.id}"
                            th:data-name="${s.name}"
                            th:data-price="${s.price}"
                            onclick="editService(this)">
                        <i class="bi bi-pencil-square"></i>
                    </button>

                    <form th:action="@{/employee/services/delete/{id}(id=${s.id})}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger rounded-0" onclick="return confirm('WARNING: This will delete the service. Continue?')">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </form>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(services)}">
                <td colspan="3" class="text-center py-5 text-secondary italic">No services found.</td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<div class="modal fade" id="serviceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary rounded-0">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-orange fw-bold" id="modalTitle">NEW SERVICE</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="serviceForm" th:action="@{/employee/services/add}" th:object="${serviceRequest}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-info bg-black border-secondary rounded-0 small text-center text-secondary">
                        <i class="bi bi-info-circle me-2"></i> All system records are stored in <strong>EUR</strong>.
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">SERVICE NAME</label>
                        <input type="text" th:field="*{name}" id="modalName"
                               class="form-control bg-black text-white border-secondary rounded-0"
                               placeholder="e.g. Engine Oil Change" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">PRICE (EUR)</label>
                        <div class="input-group">
                            <input type="number" step="0.01" th:field="*{price}" id="modalPrice"
                                   class="form-control bg-black text-white border-secondary rounded-0"
                                   placeholder="0.00" required>
                            <span class="input-group-text bg-black text-orange border-secondary rounded-0">â‚¬</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-orange w-100 rounded-0 fw-bold py-2">
                        <i class="bi bi-save me-2"></i>SAVE SERVICE
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: footer-scripts}"></div>

<script>
    function editService(element) {
        const id = element.getAttribute('data-id');
        const name = element.getAttribute('data-name');
        const price = element.getAttribute('data-price');

        document.getElementById('modalTitle').innerText = 'EDIT SERVICE';
        document.getElementById('serviceForm').action = '/employee/services/update/' + id;
        document.getElementById('modalName').value = name;
        document.getElementById('modalPrice').value = price;

        new bootstrap.Modal(document.getElementById('serviceModal')).show();
    }

    function clearModal() {
        document.getElementById('modalTitle').innerText = 'NEW SERVICE';
        document.getElementById('serviceForm').action = '/employee/services/add';
        document.getElementById('modalName').value = '';
        document.getElementById('modalPrice').value = '';
    }
</script>
</body>
</html>